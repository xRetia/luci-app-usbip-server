#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1
NAME=usbip_monitor
DAEMON=/usr/bin/usbip_monitor.sh
PIDFILE=/var/run/usbip_monitor.pid

start_service() {
    # Disable the original usbipd service to avoid conflicts
    if [ -f /etc/init.d/usbipd ]; then
        /etc/init.d/usbipd disable 2>/dev/null
        /etc/init.d/usbipd stop 2>/dev/null
    fi
    
    procd_open_instance
    procd_set_param command "$DAEMON"
    procd_set_param respawn
    procd_set_param respawn_retry 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile "$PIDFILE"
    procd_close_instance
    
    # Start usbipd server if enabled in configuration
    if [ "$(uci -q get usbip_server.config.enabled)" = "1" ]; then
        local port=$(uci -q get usbip_server.config.server_port)
        /usr/sbin/usbipd -D -4 -t -p "${port:-3240}" &
    fi
}

stop_service() {
    # Stop our monitor and usbipd server
    killall usbip_monitor.sh 2>/dev/null
    killall usbipd 2>/dev/null
}

restart() {
    stop
    sleep 2
    start
}

service_triggers() {
    procd_add_reload_trigger usbip_server
}